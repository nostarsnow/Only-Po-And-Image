!function(a,b,c){function C(){initImageBox(),initContent()}function F(){n.html(G(g.showReplys.slice(g.size*(g.page-1),g.size*g.page))),C(),o.find(".uk-active").removeClass("uk-active"),o.find(".page_"+g.page).addClass("uk-active"),w.html(g.page),g.page===g.allPage&&(v.remove(),o.find(".page_last").length<1&&t.after('<li class="page_last">'+j.last.can+"</li>"),u=o.find(".page_last"),x.html(g.allPage)),1!==g.page?(r.removeClass("uk-disabled").html(j.first.can),s.removeClass("uk-disabled").html(j.prev.can)):(r.addClass("uk-disabled").html(j.first.no),s.addClass("uk-disabled").html(j.prev.no)),(g.page!==g.allPage||!f.loaded)&&g.allPage>1?(t.removeClass("uk-disabled").html(j.next.can),u.removeClass("uk-disabled").html(j.last.can)):(t.addClass("uk-disabled").html(j.next.no),u.addClass("uk-disabled").html(j.last.no)),b("html, body").animate({scrollTop:m.offset().top},150,function(){ns.loadHide()}),ns.clickLocked=!1,g.typeChanged=!1}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,D,E,G,H,d=ns={clickLocked:!1},e=ns.formatDate=function(a,b){if(a){switch(b||(b="yyyy-MM-dd HH:mm:ss"),typeof a){case"string":a=new Date(a.replace(/-/,"/"));break;case"number":a=new Date(a)}if(!(!a instanceof Date)){var c={yyyy:a.getFullYear(),M:a.getMonth()+1,d:a.getDate(),H:a.getHours(),m:a.getMinutes(),s:a.getSeconds(),MM:(""+(a.getMonth()+101)).substr(1),dd:(""+(a.getDate()+100)).substr(1),HH:(""+(a.getHours()+100)).substr(1),mm:(""+(a.getMinutes()+100)).substr(1),ss:(""+(a.getSeconds()+100)).substr(1)};return b.replace(/(yyyy|MM?|dd?|HH?|ss?|mm?)/g,function(){return c[arguments[0]]})}}},f=ns.get={page:0,allPage:1,size:20,title:{},replys:[],loaded:!1},g=ns.push={page:1,allPage:1,size:10,showReplys:[],type:"",typeChanged:!1,paginationInit:!1},h=ns.tips={noTitle:"没有这个串！",noReplys:"该串还没有评论呢！",noMoreReplys:"没有更多评论了！",noName:"无名氏",noTitle:"无标题",noKuChuan:"请在ku岛的串下运行此插件！",noKu:"请在ku岛运行此插件！"},i=ns.api={host:a.location.href.split("?")[0].match(/(.*)\/(\d*)/),format:".json",hostname:a.location.hostname};return""==i.host[2]?(alert(ns.tips.noKuChuan),!1):(i.host=i.host[0],i.hostname.indexOf("ku")>-1?(i.imageServer="http://static.koukuko.com/h",i.url=ns.api.url=i.host+i.format,j={first:{can:'<a data-href="1">首页</a>',no:'<span data-href="1">首页</span>'},prev:{can:'<a data-href="prev">上一页</a>',no:'<span data-href="prev">上一页</span>'},next:{can:'<a data-href="next">下一页</a>',no:'<span data-href="next">下一页</span>'},last:{can:'<a data-href="last">尾页</a>',no:'<span data-href="last">尾页</span>'}},k=b("body"),l=b(".h-threads-item-main"),m=b(".h-threads-list"),n=b("#h-content .h-threads-list .h-threads-item-replys"),o=b(".h-pagination"),z=function(){y=b('<div style="position:fixed;left:0;top:0;z-index:777;background-color:rgba(0,0,0,.7);width:100%;height:100%;display:none;"><div class="uk-progress uk-progress-small uk-progress-danger uk-progress-striped uk-active" style="position: absolute;width: 50%;height:15px;top: 0;left: 0;right: 0;bottom: 0;margin: auto;line-height: 15px;"><div class="uk-progress-bar" style="width: 100%;">Loading......</div></div></div>').appendTo(k),ns.load=function(){y.fadeIn(100)},ns.loadHide=function(){y.fadeOut(200)}},A=function(){p=b('<button class="uk-button uk-margin-left uk-margin-right onlyPo" data-type="po" type="button">只看po</button>'),q=b('<button class="uk-button onlyImg" data-type="image" type="button">只看图片</button>'),l.find(".h-threads-info").append(p,q);var a=function(){var a=b(this),c=a.data("type");return c===g.type?!1:(g.typeChanged=!0,g.page=1,p.removeClass("uk-button-primary"),q.removeClass("uk-button-primary"),a.addClass("uk-button-primary"),g.type=c,b.when(E()).done(function(){var a,b;if(B(),g.allPage<=1&&g.showReplys.length<g.size&&(x.html(g.allPage<=1?1:g.allPage),v.remove(),t.after('<li class="page_last">'+j.last.can+"</li>"),u=o.find(".page_last")),a=Math.ceil(g.showReplys.length/g.size),a>2)for(b=2;a>=b;b++)v.before('<li class="page_'+b+'"><a data-href="'+b+'">'+b+"</a></li>");f.loaded&&(o.find(".page_last").length<1&&t.after('<li class="page_last">'+j.last.can+"</li>"),u=o.find(".page_last"),v.remove(),x.html(g.allPage)),F()}),void 0)};p.on("click",a),q.on("click",a),b("html, body").animate({scrollTop:m.offset().top},300)},B=function(){var a="";a+='<li class="uk-disabled page_first">'+j.first.no+"</li>"+'<li class="uk-disabled page_prev">'+j.prev.no+"</li>"+'<li class="uk-active page_1"><a data-href="1">1</a></li>',a+=1===g.allPage&&f.loaded?'<li class="uk-disabled page_next">'+j.next.no+"</li>"+'<li class="uk-pagination-next page_page">页码：<span><page class="page_now">1</page> / <page class="page_all">?</page></span></li>':'<li class="uk-disabled page_more"><a>...</a></li><li class="page_next">'+j.next.can+"</li>"+'<li class="uk-pagination-next page_page">页码：<span><page class="page_now">1</page> / <page class="page_all">?</page></span></li>',o.html(a),r=o.find(".page_first"),s=o.find(".page_prev"),t=o.find(".page_next"),u=o.find(".page_last"),v=o.find(".page_more"),w=o.find(".page_now"),x=o.find(".page_all"),g.paginationInit||(g.paginationInit=!0,o.on("click","li",function(){var d,e,h,i,a=b(this);return a.hasClass("uk-active")||a.hasClass("page_more")||a.hasClass("uk-disabled")||a.hasClass("page_page")||ns.clickLocked?!1:(ns.clickLocked=!0,d=a.find(":first").data("href"),e=g.showReplys,"next"===d?g.page++:"prev"===d?g.page--:g.page="last"===d?g.allPage:d,g.page<1&&(g.page=1),g.page>g.allPage&&(g.page=g.allPage),"next"===d?(h=e[g.size*(g.page-1)],i=e[g.size*g.page],o.find(".page_"+g.page).length<1&&(o.find(".uk-active").removeClass("uk-active"),v.before('<li class="page_'+g.page+' uk-active"><a data-href="'+g.page+'">'+g.page+"</a></li>")),h!==c&&i!==c||i===c&&f.loaded?F():b.when(E(g.type)).done(function(){F()})):F(),void 0)}))},D=function(a,b){return b=b||g.type,"po"===b?a.uid===f.title.uid:"image"===b?""!==a.image&&""!==a.thumb:void 0},E=function(a){function e(){b.ajax({url:i.url,dataType:"json",data:{page:++f.page}}).done(function(b){if(1===f.page){if(200!==b.code)return alert(h.noTitle),d.resolve(),void 0;f.allPage=b.page.size,f.title=b.threads}if(b.replys!==c&&0==b.replys.length)return console.log(h.noMoreReplys),f.page=f.allPage,f.loaded=!0,d.resolve(),void 0;var i=b.replys,k=(b.threads.uid,g.showReplys),l=g.allPage,m=k.length;return i.map(function(b,c){f.replys.push(b),D(b,a)&&k.push(c+(f.page-1)*f.size)}),g.allPage=Math.ceil(k.length/g.size),1===f.allPage&&(f.page=f.allPage,f.loaded=!0),g.allPage>l&&k.length>=g.size||m>0&&m===k.length&&f.loaded?(d.resolve(),void 0):(e(),void 0)})}var d=b.Deferred();if(a=a||g.type,ns.load(),f.loaded)g.showReplys.length=0,f.replys.map(function(a,b){D(a,g.type)&&g.showReplys.push(b)}),g.allPage=Math.ceil(g.showReplys.length/g.size),d.resolve();else if(f.replys.length>0&&g.typeChanged){if(g.showReplys.length=0,f.replys.map(function(a,b){D(a,g.type)&&g.showReplys.push(b)}),g.allPage=Math.ceil(g.showReplys.length/g.size),g.showReplys.length>=g.size)return d.resolve(),void 0;e()}else e();return d.promise()},G=ns.replysHtml=function(a){var b="";return a.map(function(a){if(reply=f.replys[a],b+='<div data-threads-id="'+reply.id+'" class="h-threads-item-reply">'+'<div class="h-threads-item-reply-icon">…</div>'+'<div class="h-threads-item-reply-main">'+'<div class="h-threads-info">'+'<span class="h-threads-info-title">'+(reply.title||ns.tips.noTitle)+"</span>"+'<span class="h-threads-info-email">'+(reply.name||ns.tips.noName)+"</span>"+'<span class="h-threads-info-createdat">'+e(reply.createdAt)+"</span>"+'<span class="h-threads-info-uid">'+"ID:"+reply.uid+(reply.uid===f.title.uid?'<span class="uk-text-primary uk-text-small">(PO主)</span>':"")+"</span>"+'<span class="h-threads-info-report-btn">'+'[<a href="/值班室?r='+reply.id+'">举报</a>]'+"</span>"+'<a href="/t/6501128?r='+reply.id+'" class="h-threads-info-id">'+"No."+reply.id+"</a>"+"</div>",""!==reply.image||""!==reply.thumb){var c=i.imageServer+reply.image,d=i.imageServer+reply.thumb;b+='<div class="h-threads-img-box"><div class="h-threads-img-tool uk-animation-slide-top"><span class="h-threads-img-tool-btn h-threads-img-tool-small uk-button-link"><i class="uk-icon-minus"></i>收起</span><a href="'+c+'" target="_blank" class="h-threads-img-tool-btn uk-button-link">'+'<i class="uk-icon-search-plus"></i>查看大图'+"</a>"+'<span class="h-threads-img-tool-btn h-threads-img-tool-left uk-button-link">'+'<i class="uk-icon-reply"></i>向左旋转'+"</span>"+'<span class="h-threads-img-tool-btn h-threads-img-tool-right uk-button-link">'+'<i class="uk-icon-share"></i>向右旋转'+"</span>"+"</div>"+'<a href="'+c+'" rel="_blank" target="_blank" class="h-threads-img-a">'+'<img data-src="'+d+'" src="'+c+'" align="left" border="0" hspace="20" class="h-threads-img">'+"</a>"+"</div>"}b+='<div class="h-threads-content">'+reply.content+"</div>"+"</div>"+"</div>"}),b},H=function(){z(),A()},H(),"function"==typeof define&&define.amd&&define("nostar",[],function(){return d}),a.nostar=d,void 0):(alert(ns.tips.noKu),!1))}(window,jQuery);